---
- name: Debug Statement
  ansible.builtin.debug:
    msg:
      START Merged deepsec_anti_malwares state for integration tests on connection={{
      ansible_connection }}

- include_tasks: _remove_atm_config.yaml

- block:
    - name: Merge and Create new AntiMalware Rules
      tags: merged
      register: result
      trendmicro.deepsec.deepsec_anti_malwares: &id001
        state: merged
        config:
          - name: test_malware_1
            description: test malware 1 description
            scan_action_for_virus: pass
            alert_enabled: true
            scan_type: on-demand
            real_time_scan: read-only
            cpu_usage: medium
          - name: test_malware_2
            description: test malware 2 description
            scan_action_for_virus: pass
            alert_enabled: true
            scan_type: real-time
            real_time_scan: read-write
            cpu_usage: low

    - name: Debug Statement
      ansible.builtin.debug:
        msg:
          - "{{ merged['after'] | symmetric_difference(result['anti_malwares']['after']) |\
            \ length }}"
          - "{{ merged['after'] | symmetric_difference(result['anti_malwares']['after']) }}"

    - name: Assert that task reports change and after dict is correctly generated
      ansible.builtin.assert:
        that:
          - result['changed'] == true
          - "{{ merged['after'] | symmetric_difference(result['anti_malwares']['after']) |\
            \ length == 4 }}"

    - name: Assert that before dicts are correctly generated
      ansible.builtin.assert:
        that:
          - merged['before'] == result['anti_malwares']['before']

    - name: Merge provided configuration with device configuration (IDEMPOTENT)
      register: result
      trendmicro.deepsec.deepsec_anti_malwares: *id001

    - name: Assert that the previous task was idempotent
      ansible.builtin.assert:
        that:
          - result['changed'] == false

  always:
    - include_tasks: _remove_atm_config.yaml
